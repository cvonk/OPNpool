<!DOCTYPE html>
<html lang="en-US" class="no-js no-svg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' id='parent-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-fonts-css'
        href='https://fonts.googleapis.com/css?family=Libre+Franklin%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C800%2C800i&#038;subset=latin%2Clatin-ext&#038;display=fallback'
        media='all' />
    <link rel='stylesheet' id='twentyseventeen-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen-child-cvonk/style.css' media='all' />
    <link rel='stylesheet' id='twentyseventeen-block-style-css'
        href='https://coertvonk.com/wp-content/themes/twentyseventeen/assets/css/blocks.css' media='all' />
    <link rel='stylesheet' id='fancybox-css'
        href='https://coertvonk.com/wp-content/plugins/easy-fancybox/css/jquery.fancybox.min.css' media='screen' />
    <style id='fancybox-inline-css'>
        #fancybox-content {
            border-color: #fff;
        }
    </style>
    <!-- MathJax 3.2 config -->
    <script>
        window.MathJax = {
            loader: {
                load: ['[tex]/cancel', '[tex]/physics']
            },
            tex: {
                packages: {
                    '[+]': ['cancel',]
                },
                macros: {
                    shaded: ["{\\bbox[5pt,background-color:##F7F7D2]{#1}}", 1],
                },
                tags: 'all',
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script type="text/javascript">
        /* <![CDATA[ */
        document.querySelectorAll("ul.nav-menu").forEach(
            ulist => {
                if (ulist.querySelectorAll("li").length == 0) {
                    ulist.style.display = "none";

                }
            }
        );
        /* ]]> */
    </script>
    <style>
        div.flex-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
        }

        div.flex-container>* {
            flex-grow: 1;
            max-width: 80%;
        }

        div.flex-container.math>* {
            max-width: 100%;
        }

        div.flex-container.tight>* {
            flex-grow: unset;
            max-width: unset;
        }

        .mathtbl>tbody>tr>td {
            border-collapse: collapse;
            border: 1px solid black;
            text-align: left;
        }

        .mathtbl>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml>tbody>tr>td {
            text-align: center !important;
            border-collapse: collapse;
            border: 1px solid black;
            padding: 0px;
        }

        .mathtblsml>tbody>tr>th {
            border-collapse: collapse;
            border: 1px solid black;
            background-color: rgb(245, 245, 255);
            color: black;
            text-align: center;
        }

        .mathtblsml {
            font-size: 0.8em;
            margin: auto;
            border-spacing: 0px;
        }

        @media print {

            .no-print,
            .no-print * {
                display: none !important;
            }
        }

        .hp41-key {
            font-family: Verdana, Arial, "Times new roman";
            font-size: 10px;
            line-height: 12px;
            font-weight: bold;
            white-space: nowrap;
            padding: 0px 2px;
            color: #000000;
            border: #000000 1px solid;
            border-radius: 3px;
            background-color: #f8f8f8;
        }        
        table.error,
        table.decoded,
        table.partition {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.error tr > th,
        table.error tr > td,
        table.decoded tr > th,
        table.decoded tr > td,
        table.partition tr > th,
        table.partition th > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: wrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.error tr > th,
        table.decoded tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.error tr > *:nth-last-child(2),
        table.decoded tr > *:nth-last-child(2),
        table.partition tr > *:first-child {
            border-right: 1px solid black;
        }

        table.connections,
        table.partition {
            margin: 0 auto;
            margin-top: 1em;
        }
        table.bom {
            margin: 0 auto;
            width: 100%;
            margin-top: 1em;
        }
        table.connections tr > th,
        table.connections tr > td,
        table.bom tr > th,
        table.bom tr > td,
        table.partition tr > th,
        table.partition tr > td {
            font-size: 0.8em;
            border: 1px solid #eee;
            text-align: left;
            vertical-align: top;
            white-space: nowrap;
            padding: 0.1rem 0.5rem 0.1rem 0.5rem;
        }
        table.connections tr > td {
            text-align: center;
        }
        table.partition tr > td {
            text-align: left;
        }
        table.connections tr > th,
        table.bom tr > th,
        table.partition tr > th {
            font-style: italic;
            border-collapse: collapse;
            text-align: center;
            border-bottom: 1px solid black;
        }
        table.connections tr > .borderright,
        table.connections tr > *:nth-last-child(4),
        table.connections tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(2),
        table.bom tr > *:nth-last-child(3) {
            border-right: 1px solid black;
        }

    </style>
</head>

<body><div class="entry-content" style="margin: 40px">
<h1>Debugging</h1>

<p>
    Describes methods for debugging the pool interface. Includes JTAG debugging and post-mortem coredump analysis.
</p>

<h2>
    Post mortem
</h2>
<p>
    The device includes support to generate core dumps on unrecoverable errors. This allows post-mortem analysis of the software state at the moment of failure. This way you can find what task, the instruction and what call stack lead to the crash. The core dump is written to the <code>coredump</code> partition in flash. 
</p>
<p>
    As we will see in the Interface chapter, the <code>mqtt_task</code> will read this coredump from flash and forward it over MQTT. 
</p>

<h2>
    GDB over JTAG
</h2>
<p>
    The ESP32 supports the <a href="http://openocd.org/">Open On-Chip Debugger</a>. Say goodbye to <code>ESP_LOG</code>, and explore the world that was once the exclusive domain of in-circuit emulators. Using special pins on the ESP32, your computer can set break points, inspect variables and single step instructions.

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-debug-openocd-scaled.jpg"><img src="https://coertvonk.com/wp-content/uploads/opnpool-debug-openocd-1024x683.jpg" alt="" width="525" height="350" class="alignnone size-large wp-image-32127" /></a>
            <figcaption>
                OPNpool with ESP-PROG and computer
            </figcaption>
        </figure>
    </div>
</p>

<h3>
    ESP32 board and JTAG adapter
</h3>
<p>
    The JTAG interface hooks directly to the CPU. That allows it do stop the CPU, set breakpoints and have access to whatever the CPU has access to.
</p>
<p>
    The JTAG header is available on the OPNpool board.  This 10 pin header should be connected to a JTAG/USB interface, such as the ESP-PROG. With the interface, make sure to set the <code>JTAG PWR SEL</code> jumper for 3.3V. Also try to keep the connection short (&lt;10 cm).
</p>
<p>
    <details>
        <summary>
            Another option is to use the ESP-WROVER-KIT development board.
        </summary>
        <div style="margin-left: 2em; color: grey;">
            The ESP-WROVER-KIT has an integrated JTAG/USB interface what is available over the first of two USB channels. (The second channel is for the serial port.)  If you go this route, make sure to connect the JTAG jumpers on JP2 to prevent <code>Error: libusb_open() failed with LIBUSB_ERROR_NOT_SUPPORTED</code>.
        </div>
    </details>
</p>

<h3>
    OpenOCD and driver
</h3>
<p>    
    Under Windows, install the 64-bit <a href="https://www.ftdichip.com/Drivers/D2XX.htm">FTDI D2xx Driver</a> setup executable;
    <ol>
        <li>
            Using micro-USB cables, connect JTAG adapter and the serial port on the OPNpool board to the computer. 
        </li>
        <li>
            Wait until USB ports are recognized by Windows and drivers are installed. If they do not install automatically, then do so manually using the driver setup from <a href="https://www.ftdichip.com/Drivers/D2XX.htm">FTDI</a>.
        </li>
        <li>
            Install and run the <a href="https://zadig.akeo.ie/">Zadig tool</a> (&ge; v2.7).
            <ul>
                <li>
                    <code>Options » List All Devices</code>
                </li>
                <li>
                    The list of devices should contain two ESP-PROG specific USB entries with driver name "FTDIBUS (vxxxx)":
                    <ul>
                        <li>
                            <code>Dual RS232-HS (Interface 0)</code>, connected to the JTAG port
                        </li>
                        <li>
                            <code>Dual RS232-HS (Interface 1)</code>, connected to the UART port
                        </li>
                    </ul>
                </li>
                <li>
                    Select <code>Dual RS232-HS (Interface 0)</code>, and reinstall attached driver to the “WinUSB (v6xxxxx)”, see the picture below.
                </li>
            </ul>
        </li>
        <li>
            Windows Device Manager should no longer show the JTAG port, because <code>WinUSB</code> is a user-space driver.
        </li>
    </ol>

    <div class="flex-container tight">
        <figure>
            <a href="https://coertvonk.com/wp-content/uploads/opnpool-debug-zadig.png"><img src="https://coertvonk.com/wp-content/uploads/opnpool-debug-zadig.png" alt="" width="500" class="alignnone size-full wp-image-32125" /></a>    
            <figcaption>
                Zadig to configure WinUSB driver.
            </figcaption>
        </figure>
    </div>
</p>

<h3>
    Compile and debug
</h3>
<p>
    Set up the OpenOCD configuration
    <ol>
        <li>
            <code><cspan class="hp41-key">F1</cspan> » Select OpenOCD Board Configuration</code>.
        </li>
        <li>
            Choose the <code>ESP32 chip (via ESP-PROG)</code>.  (Unless you use the ESP-WROVER-KIT of course.)
            <ul>
                <li>
                    Note that WROVER modules use a 1.8 SPI flash because of PSRAM limitations.
                </li>
                <li>
                    Others such as WROOM modules use 3.3V SPI flash.  This flash voltage is important, because <code>GPIO12</code> is shared with SPI flash.  Selecting the wrong voltage may cause flash uploads to fail.
                </li>
            </ul>  
        </li>
    </ol>
</p>
<p>
    See if OpenOCD starts
    <ol>
        <li>
            <code><cspan class="hp41-key">F1</cspan> » ESP-IDF: OpenOCD Manager</code>.
        </li>
        <li>
            Choose <code>Start OpenOCD</code>.
        </li>
    </ol>
</p>
<p>
    Build the code with symbols and without optimalizations.

    <ol>
        <li>
            <code><cspan class="hp41-key">F1</cspan> » ESP-IDF: Launch GUI configuration tool</code>
        </li>
        <li>
            Specify the <code>Debug (-Og)</code> compiler optimalization level.
        </li>
        <li>
            Press <cspan class="hp41-key">^e</cspan> <cspan class="hp41-key">d</cspan> to build, upload and monitor over the serial port. 
            <ul>
                <li>
                    If the "search documentation" keyboard shortcut is also assigned to <cspan class="hp41-key">^e</cspan> <cspan class="hp41-key">d</cspan>, then first remove that binding.
                </li>
                <li>
                    Note that you can also upload the binary over JTAG (<code>program_esp filename.bin 0x10000 verify</code>).
                </li>
            </ul>
        </li>
    </ol>
</p>
<p>
    From the VSCode debug side bar (<cspan class="hp41-key">^e</cspan> <cspan class="hp41-key">d</cspan>), click on the green arrow at the top and select <code>Launch</code> to connect to the OPNpool device.
</p>

<h4>
    Notes
</h4>
<p>
    <ul>
        <li>
            There are only two hardware breakpoints
        </li>
        <li>
            After hitting a break point, you may still have to select the corresponding task
        </li>
        <li>
            To determine the image location in flash, OpenOCD uses the address of the first `app` in the partition table. When using OTA updates, this will be the <code>factory</code> image instead of the OTA downloaded application. To work around this, specify <code>esp32 appimage_offset <offset></code> (see <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/jtag-debugging/tips-and-quirks.html">docs.espressif.com</a>).
        </li>
        <li>
            You may only want to debug the 1st core (<code>set ESP32_ONLYCPU 1</code>)
        </li>
        <li>
            Espressif has more info in <a href="https://docs.espressif.com/projects/esp-idf/en/latest/esp32/api-guides/jtag-debugging/index.html">Espressif JTAG Debugging</a>
        </li>
    </ul>
</p>
<p>
    <div class="continue-container no-print">
        <div class="continue-content">
            <div class="continue-text">
                Continue reading to learn about the <a href="https://coertvonk.com/sw/pool-interface/protocol-31965">communication protocol</a>.
        </div>
    </div>    
</p>
            
</div></body>
